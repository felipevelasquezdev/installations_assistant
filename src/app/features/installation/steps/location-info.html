<!-- src/app/features/installation/steps/location-info.html -->

<form [formGroup]="form" (ngSubmit)="onSubmit()">

  <!-- Tipo de ubicación -->
  <fieldset class="mb-6">
    <legend class="text-sm font-medium text-gray-700 mb-3">
      Tipo de ubicacion
    </legend>
    <div class="grid grid-cols-2 gap-3">

      <label
        class="flex items-center justify-center p-3 rounded-xl border-2 cursor-pointer transition-colors"
        [class.border-blue-600]="form.controls.locationType.value === 'neighborhood'"
        [class.bg-blue-50]="form.controls.locationType.value === 'neighborhood'"
        [class.border-gray-200]="form.controls.locationType.value !== 'neighborhood'"
      >
        <input
          type="radio"
          formControlName="locationType"
          value="neighborhood"
          class="hidden"
          (change)="onLocationTypeChange('neighborhood')"
        />
        <span class="text-sm font-medium text-gray-700">Barrio</span>
      </label>

      <label
        class="flex items-center justify-center p-3 rounded-xl border-2 cursor-pointer transition-colors"
        [class.border-blue-600]="form.controls.locationType.value === 'village'"
        [class.bg-blue-50]="form.controls.locationType.value === 'village'"
        [class.border-gray-200]="form.controls.locationType.value !== 'village'"
      >
        <input
          type="radio"
          formControlName="locationType"
          value="village"
          class="hidden"
          (change)="onLocationTypeChange('village')"
        />
        <span class="text-sm font-medium text-gray-700">Vereda</span>
      </label>

    </div>
  </fieldset>

  <!-- Nombre del barrio o vereda -->
  <div class="mb-4">
    <label class="block text-sm font-medium text-gray-700 mb-1">
      {{ locationNameLabel }}
    </label>
    <input
      type="text"
      formControlName="locationName"
      [placeholder]="'Ej: ' + locationNameLabel"
      class="w-full px-4 py-2.5 rounded-xl border border-gray-200 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition"
    />
    @if (form.controls.locationName.invalid && form.controls.locationName.touched) {
      <p class="text-red-500 text-xs mt-1">{{ locationNameLabel }} es obligatorio</p>
    }
  </div>

  <!-- Dirección o referencia -->
  <div class="mb-4">
    <label class="block text-sm font-medium text-gray-700 mb-1">
      {{ addressLabel }}
    </label>
    <textarea
      formControlName="addressOrReference"
      [placeholder]="addressPlaceholder"
      rows="3"
      class="w-full px-4 py-2.5 rounded-xl border border-gray-200 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition resize-none"
    ></textarea>
    @if (form.controls.addressOrReference.invalid && form.controls.addressOrReference.touched) {
      <p class="text-red-500 text-xs mt-1">{{ addressLabel }} es obligatorio</p>
    }
  </div>

  <!-- Coordenadas -->
  <div class="mb-4">
    <label class="block text-sm font-medium text-gray-700 mb-2">
      Coordenadas
    </label>

    <!-- Cargando -->
    @if (isLoadingLocation()) {
      <div class="flex items-center gap-2 text-sm text-blue-600 mb-2">
        <svg class="w-4 h-4 animate-spin" viewBox="0 0 24 24" fill="none">
          <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"/>
          <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v8z"/>
        </svg>
        Obteniendo ubicacion automatica...
      </div>
    }

    <!-- Requiere confirmación manual -->
    @if (requiresManualConfirmation() && !isLoadingLocation()) {
      <div class="bg-yellow-50 border border-yellow-200 rounded-xl px-4 py-3 mb-3">
        <p class="text-yellow-800 text-xs font-medium mb-1">Ubicacion manual requerida</p>
        <p class="text-yellow-700 text-xs">
          No se pudo obtener tu ubicacion automaticamente.
          Mueve el marcador o toca el mapa hasta la ubicacion exacta de la instalacion
          y luego toca "Confirmar ubicacion".
        </p>
        <button
          type="button"
          (click)="onRetryLocation()"
          class="text-xs text-yellow-800 font-semibold underline mt-1"
        >
          Intentar obtener ubicacion automatica
        </button>
      </div>
    }

    <!-- Ubicación confirmada automáticamente -->
    @if (locationConfirmed() && !requiresManualConfirmation()) {
      <div class="flex items-center gap-2 bg-green-50 border border-green-200 rounded-xl px-3 py-2 mb-3">
        <svg class="w-4 h-4 text-green-600 shrink-0" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
          <path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7"/>
        </svg>
        <p class="text-green-700 text-xs font-medium">Ubicacion obtenida automaticamente</p>
      </div>
    }

    <!-- Inputs de coordenadas -->
    <div class="grid grid-cols-2 gap-2 mb-3">
      <div>
        <label class="block text-xs text-gray-500 mb-1">Latitud</label>
        <input
          type="text"
          [value]="latitudeDisplay()"
          placeholder="5.623889"
          readonly
          class="w-full px-3 py-2 rounded-xl border border-gray-200 text-sm bg-gray-50 text-gray-700 cursor-not-allowed"
        />
      </div>
      <div>
        <label class="block text-xs text-gray-500 mb-1">Longitud</label>
        <input
          type="text"
          [value]="longitudeDisplay()"
          placeholder="-73.531944"
          readonly
          class="w-full px-3 py-2 rounded-xl border border-gray-200 text-sm bg-gray-50 text-gray-700 cursor-not-allowed"
        />
      </div>
    </div>

    <!-- Mapa -->
    <div #mapContainer class="map-container border border-gray-200"></div>
    <p class="text-xs text-gray-400 mt-1">
      Arrastra el marcador o toca el mapa para ajustar la ubicacion
    </p>

    <!-- Botón confirmar ubicación manual -->
    @if (requiresManualConfirmation()) {
      <button
        type="button"
        (click)="onConfirmLocation()"
        [disabled]="!latitudeDisplay()"
        class="w-full mt-3 py-2.5 rounded-xl text-sm font-semibold transition-colors"
        [class.bg-blue-600]="latitudeDisplay()"
        [class.text-white]="latitudeDisplay()"
        [class.hover:bg-blue-700]="latitudeDisplay()"
        [class.bg-gray-100]="!latitudeDisplay()"
        [class.text-gray-400]="!latitudeDisplay()"
        [class.cursor-not-allowed]="!latitudeDisplay()"
      >
        Confirmar ubicacion
      </button>
    }

    <!-- Ubicación confirmada manualmente -->
    @if (locationConfirmed() && requiresManualConfirmation()) {
      <div class="flex items-center gap-2 bg-green-50 border border-green-200 rounded-xl px-3 py-2 mt-2">
        <svg class="w-4 h-4 text-green-600 shrink-0" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
          <path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7"/>
        </svg>
        <p class="text-green-700 text-xs font-medium">Ubicacion confirmada manualmente</p>
      </div>
    }

  </div>

  <!-- Botones -->
  <div class="flex gap-3 mt-8">
    <button
      type="button"
      (click)="onGoBack()"
      class="w-1/3 py-3 rounded-xl text-sm font-semibold bg-gray-100 text-gray-600 hover:bg-gray-200 transition-colors"
    >
      Volver
    </button>
    <button
      type="submit"
      [disabled]="!canSubmit"
      class="w-2/3 py-3 rounded-xl text-sm font-semibold transition-colors"
      [class.bg-blue-600]="canSubmit"
      [class.text-white]="canSubmit"
      [class.hover:bg-blue-700]="canSubmit"
      [class.bg-gray-100]="!canSubmit"
      [class.text-gray-400]="!canSubmit"
      [class.cursor-not-allowed]="!canSubmit"
    >
      Continuar
    </button>
  </div>

</form>
